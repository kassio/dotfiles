#!/usr/bin/env bash

exec 3> /dev/stdout
exec 1> /dev/null
exec 2> /dev/null

pushd "${PWD}" &&
  trap 'popd' EXIT HUP INT QUIT TERM

IFS=':' read -ra files <<< "${REPOS_FILES}"

printc() { ~/.dotfiles/bin/printc "$@" >&3; }
_failed() { printc -c 196 " ✗ Failed!\n"; }
_succeed() { printc -c 34 " ✓ Succeed!\n"; }

for file in "${files[@]}"; do
  while IFS='|' read -r remote p; do
    [ "${remote}" == "" ] && continue

    p="${p//\$HOME/$HOME}"

    if [ -d "${p}" ]; then
      printc "Running '$*' in '${p}': "
      pushd "${p}" || exit
      if eval "$*"; then
        _succeed
      else
        _failed
      fi
      popd || exit
    fi
  done < "${file}"
done
