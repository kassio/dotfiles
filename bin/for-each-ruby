#!/usr/bin/env zsh

source "${HOMEBREW_PREFIX}/opt/asdf/libexec/asdf.sh"
_cmd="$*"

run() {
  rb="$(echo "$1" | sed 's/[^0-9.]//g')"

  eval "asdf shell ruby ${rb} 2>/dev/null"
  echo "with ruby: $(asdf current ruby)"

  if ! eval "${_cmd}"; then
    echo "$* failed for ${rb}"
    return 1
  else
    return 0
  fi
}

while read -r rb
do
  if ! run ${rb}; then
    continue
  fi
done < <(asdf list ruby 2>/dev/null)

asdf shell ruby --unset
