#!/usr/bin/env zsh

basepath="$(dirname "$(realpath "$0")")"

tools=(
  "repos_sync"
  "apple"
  "duti"
  "brew"
  "bat"
  "delta"
  "zsh_plugins"
  "asdf"
  "ruby"
  "golang"
  "quarentine"
  "nvim"
  "wezterm"
  "1password"
  "custom"
)

only=""
except=""
parse_args() {
  case "${1}" in
    --only)
      shift
      only="${1}"
      shift
      return
      ;;
    --except)
      shift
      except="${1}"
      shift
      ;;
    *)
      return
  esac

  parse_args "$@"
}; parse_args "$@"

upgrade_with() {
  local tool="${1}"; shift

  "${basepath}/upgraders/${tool}" "$@"
}

if [ "${1}" = "-h" ] || [ "${1}" = "--help" ]; then
  echo 'Usage: upgrade [--only "<upgrader>"|--except "<upgrader1:upgrader2:upgrader3:...>"]'
  echo 'List of upgraders:'
  echo
fi

initial_ts=$(date +%s)
if [ "${only}" != "" ]; then
  upgrade_with "${only}" "$@"
else
  for tool in "${tools[@]}"; do
    if [[ "${except}" != *"${tool}"* ]]; then
      upgrade_with "${tool}"
    fi
  done
fi

execution=$(echo "${initial_ts} - $(date +%s)" | bc -l)
notify "Upgraded in ${execution} seconds"
clear-screen
