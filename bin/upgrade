#!/usr/bin/env bash

LOGFILE="/tmp/upgrade.log"
apple=true
git=true
verbose=true

for option in $@
do
  case ${option} in
    -a|--apple)
      apple=true
      ;;
    -A|--no-apple)
      apple=false
      ;;
    -G|--no-git)
      git=false
      ;;
    -g|--git)
      git=true
      ;;
    -q|--quiet)
      verbose=false
      ;;
    -v|--verbose)
      verbose=true
      ;;
    -h|--help)
      print-help
      exit 0
      ;;
  esac
done

echo "--- $(date +"%Y-%m-%d %H:%M:%S") ---" >${LOGFILE}

exec 3>/dev/stdout
if [ "${verbose}" = true ]
then
  exec > >(tee -a ${LOGFILE}) 2>&1
else
  exec >${LOGFILE} 2>&1
fi

title() {
  local blue='\e[0;36m'
  local yellow='\e[0;93m'
  local reset='\e[00m'
  local bullet="${yellow}â–¸ "

  printf "${bullet}${blue}$*${reset}\n" | tee -a ${LOGFILE} >&3
}

print-help() {
  echo -e "USAGE: upgrade [options]
  Upgrade your system
  Options:
  -a, --apple      Update apple softwareupdate [default];
  -A, --no-apple   Do not update apple softwareupdate;
  -g, --git        Update your git repositories in the \$REPOS, default [default];
  -G, --no-git    Do not update your git repositories;
  -v, --verbose    Show what's going on [default];
  -q, --quiet      Do not show what's going on;
  -h, --help       Show this help message;
"
}

_upgrade() {
  trap 'exit -1' EXIT HUP INT QUIT TERM

  if [ "${git}" = true ]
  then
    title "updating repositories"
    update-repos
  fi

  if [ "${apple}" = true ]
  then
    title "Apple upgrade"
    softwareupdate -ia
  fi

  title "brew upgrade"
  brew update
  brew upgrade --fetch-HEAD
  brew cleanup

  title "atom packages upgrade"
  yes | apm upgrade

  title "neovim/vim packages upgrade"
  ${HOME}/.config/nvim/bin/pack
}

_upgrade
echo
