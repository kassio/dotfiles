#!/usr/bin/env zsh

components_path="${DOTFILES}/bin/upgraders"
timestamp_file="${HOME}/.config/.last-upgrade"

_exit() {
  date -j '+%d %b %Y %H:%M' > "${timestamp_file}"
  exit "$1"
}

_last_upgrade() {
  if [ -f "${timestamp_file}" ]; then
    title "Last upgrade was done on $(cat "${timestamp_file}").\n"
  fi
}

_component_name() { echo "$1" | sed -E "s/^[^_]*_//"; }

_clear_buffer() { echo -n -e '\e[2J\e[3J\e[1;1H'; }

_upgrade() {
  trap '_exit -1' HUP INT QUIT TERM

  _clear_buffer

  _last_upgrade

  local only_param="${1#--}"
  if [ -n "${only_param}" ]; then
    local only
    only="$(find "${components_path}" -name "*${only_param}")"

    if [ -n "${only}" ]; then
      eval "${only} $*"
      _exit 0
    fi
  fi

  while read -r component; do
    name="$(_component_name "${component}")"

    case "$*" in
      *"--no-${name}"*)
        continue
        ;;
      *)
        zsh -c "${components_path}/${component} $*"
        ;;
    esac
  done < <(ls -1 "${components_path}/")

  _exit 0
}

case "$1" in
  --help | -h)
    echo -e "USAGE: upgrade [options]
    Upgrade your system components

  Options:
    --[component]
      Will upgrade only the given component

    --no-[component]
      Will skip the component and upgrade all the others.
      This option may be used more than once.

  Components:"
    for component in $(ls -1 "${components_path}/"); do
      echo -e "\t\t- $(_component_name "${component}"): $("${components_path}/${component}" --help)"
    done
    exit 0
    ;;
esac

_upgrade "$@"

echo

_exit 0
