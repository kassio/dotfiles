#!/usr/bin/env zsh

local components_path="${DOTFILES}/bin/upgraders"
local components=($( find "${components_path}" -type f | sort | xargs basename; ))
local timestamp_file="${HOME}/.config/.last-upgrade"

_exit() {
  date -j '+%d %b %Y %H:%M' > "${timestamp_file}"
  exit "$1"
}

_last_upgrade() {
  if [ -f "${timestamp_file}" ]; then
    title "Last upgrade was done on $(cat "${timestamp_file}").\n"
  fi
}

_component_name() { echo "$1" | sed -E "s/^[^_]*_//"; }

_clear_buffer() { echo -n -e '\e[2J\e[3J\e[1;1H'; }

_upgrade() {
  trap '_exit -1' HUP INT QUIT TERM

  _clear_buffer

  _last_upgrade

  local only_param="${1#--}"
  local only="${components_path}/${only_param}"
  if [ -n "${only_param}" ] && [ -f "${only}" ]; then
    zsh -c "${only} $*"
    _exit 0
  fi

  for component in "${components[@]}"; do
    name="$(_component_name "${component}")"

    case "$*" in
      *"--no-${name}"*)
        title "skipping ${name}"
        continue
        ;;
    esac

    zsh -c "${components_path}/${component} $*;"
  done

  _exit 0
}

case "$1" in
  --help | -h)
    echo -e "USAGE: upgrade [options]
    Upgrade your system components

  Options:
    --[component]
      Will upgrade only the given component

    --no-[component]
      Will skip the component and upgrade all the others.
      This option may be used more than once.

  Components:"
    for component in "${components[@]}"; do
      echo -e "\t\t- $(_component_name "${component}"): $("${components_path}/${component}" --help)"
    done
    exit 0
    ;;
esac

_upgrade "$@"

echo

_exit 0
