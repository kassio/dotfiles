#!/usr/bin/env zsh

help() {
  cat <<EOF
Usage: nvim-diff [[--except|-e] "expression"|[--only|-o] "expression"]

Without arguments will open all the files that changed
between the current branch and the main one.

The list of files can be
  - filtered out (--except|-e) OR
  - filtered in (--only|-o)

"expression" can be any 'grep' expression.
EOF
}

except=""
only=""

case "$1" in
  -e|--except)
    shift
    except="$1"
    ;;

  -o|--only)
    shift
    only="$1"
    ;;

  *)
    help
    exit
    ;;

esac;

filter() {
  if [ "$except" != "" ]; then
    echo "$@" | grep -v "$except"
  elif [ "$only" != "" ]; then
    echo "$@" | grep "$only"
  else
    echo "$@"
  fi
}

filter "$(git diff --name-only --diff-filter=d "$(g-main-branch)")" |
  xargs nvim -p
