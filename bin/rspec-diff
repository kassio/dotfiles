#!/usr/bin/env zsh

ref=""
if [ "$#" -gt 0 ]; then
  ref="$1"
  shift
fi

not_found=()
not_modified=()
changed_specs=(
  $(git-diff-names-to "${ref}" |
    grep '_spec.rb')
  )
possible_specs=(
  $(git-diff-names-to "${ref}" |
    grep -v spec |
    xargs -I{} echo {} | sed 's;^app;spec;' |
    xargs -I{} echo {} | sed 's;^ee/app;ee/spec;' |
    xargs -I{} echo {} | sed 's;^lib;spec/lib;' |
    xargs -I{} echo {} | sed 's;^ee/lib;ee/spec/lib;' |
    xargs -I{} echo {} | sed 's;.rb;_spec.rb;')
  )

specs+=( "${changed_specs[@]}" )
for file in "${possible_specs[@]}"; do
  if [ -f "${file}" ]; then
    if [ "${specs[(Ie)${file}]}" -le 0 ]; then
      not_modified+=( "${file}" )
    fi

    specs+=( "${file}" )
  else
    not_found+=( "${file}" )
  fi
done

echo "${#changed_specs[@]} specs changed"
for file in "${changed_specs[@]}"; do
  echo "\t- ${file}"
done
echo "---"
echo "${#not_modified[@]} specs not updated"
for file in "${not_modified[@]}"; do
  echo "\t- ${file}"
done
echo "---"
echo "${#not_found[@]} missing specs:"
for file in "${not_found[@]}"; do
  echo "\t- ${file}"
done
echo "---"

set -x
bundle exec rspec "$@" "${specs[@]}"
