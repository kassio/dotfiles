#!/usr/bin/env bash

function update-repo() {
  trap 'exit -1' EXIT HUP INT QUIT TERM

  local OK=" 👌 "
  local NOK=" 🚫 "

  function fetch-master() {
    local icon=" 🔅 "
    local path="$(basename ${PWD})"
    echo -n "${icon} fetching master on ${PWD}"

    update-master -q
    result_status
  }

  function rebase() {
    local master=$(cat .git/custom-master 2>/dev/null || echo 'master')
    local branch=$(git symbolic-ref --short HEAD)
    local icon=" ➡️  "

    if [ "${branch}" != "${master}" ]
    then
      echo -ne "\n   ${icon} Rebasing '${branch}' on '${master}'"
      git rebase ${master} &>/dev/null
      result_status
    fi
  }

  function result_status() {
    local status=$?

    if [ ${status} -eq 0 ]
    then
      echo -n "${OK}"
    else
      echo -n "${NOK}"
    fi

    return ${status}
  }

  fetch-master && rebase
  echo -ne "\n"
}

export -f update-repo

pushd "${PWD}" > /dev/null && trap 'popd &> /dev/null' EXIT HUP INT QUIT TERM

for-each-repo update-repo

unset -f update-repo
