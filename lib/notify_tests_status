#!/usr/bin/env bash

export TEST_NOTIFIER_BOOTING=1

function notifier {
  if [[ $(uname) == 'Darwin' ]]
  then
    `which terminal-notifier` -group 'TMUX' -message $1 &>/dev/null
  else
    `which notify-send` $1 &>/dev/null
  fi
}

function __notify_tests_status {
  local last_status="$?"
  local last_fc="$(fc -l -1 | tr -s ' ')"
  local last_command="$(echo $last_fc | cut -d' ' -f 3-)"

  trap "{ return $last_status }" SIGINT

  if [ "$TEST_NOTIFIER_BOOTING" = "" ]
  then
    case $last_command in
      *notify_tests_status*)
        ;;
      spec*|rspec*|rake\ test*|ruby*test*)
        if [ $last_status -eq 0 ]
        then
          notifier 'SUCCESS :)'
        else
          notifier 'FAILED :('
        fi
        ;;
    esac
  else
    unset TEST_NOTIFIER_BOOTING
  fi

  return $last_status
}
